<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EB-2 NIW 예비 평가 앱 · Law Office of Hong‑min Jun</title>
<meta name="description" content="EB-2 NIW(국가이익면제) 예비 평가를 위한 대화형 웹 앱. Dhanasar 3프롱 기반 평가, 프로파일/가중치, 리포트 내보내기, PDF/복사/이메일 안내.">
<style>
:root{
  --bg:#f6f7fb;--card:#ffffff;--text:#111827;--muted:#6b7280;--border:#e5e7eb;
  --primary:#0ea5e9;--primary-dark:#0284c7;
  --ok:#065f46;--warn:#92400e;--bad:#991b1b;
  --chip:#eef2ff;--chiptext:#3730a3;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0}
body{
  background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"Apple SD Gothic Neo","Noto Sans KR",Helvetica,Arial,sans-serif;
  line-height:1.55
}
.container{max-width:1100px;margin:18px auto;padding:0 16px}
header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
.brand{display:flex;gap:10px;align-items:center}
.brand .logo{
  width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#60a5fa,#34d399);
  display:flex;align-items:center;justify-content:center;color:white;font-weight:800;box-shadow:0 2px 8px rgba(0,0,0,.12)
}
.brand h1{font-size:18px;margin:0}
.badge{background:var(--chip);color:var(--chiptext);border:1px solid #c7d2fe;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.04);margin-bottom:12px}
.card h2{margin:0 0 6px;font-size:18px}
.sub{color:var(--muted);font-size:13px;margin-top:-4px}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{
  background:var(--primary);color:#fff;border:1px solid var(--primary-dark);
  border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer
}
.btn.secondary{background:#fff;color:var(--primary-dark)}
.btn.ghost{background:#fff;color:#374151;border:1px solid #e5e7eb}
.btn.warn{background:#ef4444;border-color:#b91c1c}
.progress{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin:8px 0 0}
.progress>div{height:100%;background:linear-gradient(90deg,#38bdf8,#22c55e);width:0%}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
label{font-weight:700}
input[type="text"],input[type="number"],input[type="date"],textarea,select{
  border:1px solid #d1d5db;border-radius:10px;padding:10px;font-size:14px;background:#fff;width:100%
}
input[type="range"]{width:100%}
textarea{min-height:88px;resize:vertical}
.kv{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
.kv .chip{border:1px dashed #d1d5db;padding:6px 10px;border-radius:999px;font-size:12px;background:#fff}
.muted{color:var(--muted);font-size:12px}
.sticky-banner{position:sticky;top:0;z-index:1000;border:1px solid #fde68a;background:#fffbeb;color:#92400e;border-radius:14px;padding:12px 14px;margin-bottom:12px}
.step{display:none}
.step.active{display:block}
.nav{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
.nav .left,.nav .right{display:flex;gap:8px}
.result{border:1px solid var(--border);background:#f9fafb;border-radius:16px;padding:16px;margin-top:12px}
.pill{display:inline-block;border:1px dashed #d1d5db;padding:6px 10px;border-radius:999px;font-size:12px;background:#fff;margin:4px 6px 0 0}
.hr{height:1px;background:#e5e7eb;margin:12px 0}
.ok{color:var(--ok);background:#ecfdf5;border-color:#a7f3d0}
.warn{color:var(--warn);background:#fffbeb;border-color:#fde68a}
.bad{color:var(--bad);background:#fef2f2;border-color:#fecaca}
footer{margin:26px 0 16px;text-align:center;color:#9ca3af;font-size:12px}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
/* Settings panel */
.settings{display:none}
.settings.active{display:block}
.setting-row{display:grid;grid-template-columns:1.2fr 2.8fr 0.8fr;gap:10px;align-items:center;margin-bottom:8px}
.setting-row span{font-size:13px;color:#374151}
.value-badge{display:inline-block;min-width:42px;text-align:center;border:1px solid #d1d5db;border-radius:8px;padding:6px 8px;font-size:12px;background:#fff}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">HJ</div>
        <div>
          <h1>EB‑2 NIW 예비 평가 앱</h1>
          <div class="badge">Law Office of Hong‑min Jun · Indiana · Illinois</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn ghost" onclick="toggleSettings()">⚙️ 설정</button>
        <button class="btn ghost" onclick="saveDraft()">진행 저장</button>
        <button class="btn ghost" onclick="loadDraft()">불러오기</button>
        <button class="btn warn" onclick="resetAll()">초기화</button>
      </div>
    </header>

    <div class="sticky-banner">
      <strong>면책:</strong> 본 도구는 <em>참고용 예비 평가</em>를 제공합니다. NIW는 정량 지표 합산만으로 단정할 수 없습니다. 
      <strong>최종 서류화는 저희 전홍민 변호사 사무실과 상의하시기를 권유합니다.</strong>
    </div>

    <!-- Settings / Profile -->
    <div class="card settings" id="settingsPanel">
      <h2>⚙️ 설정 — 프로파일 & 가중치</h2>
      <p class="sub">분야 특성에 맞춰 휴리스틱 가중치를 미세 조정합니다. (기본=1.0 · 범위 0.5–1.5)</p>
      <div class="grid">
        <div class="field">
          <label>프로파일</label>
          <select id="profile" onchange="applyProfile()">
            <option value="default">기본(균형)</option>
            <option value="academic">학자형(Academic)</option>
            <option value="entre">기업가형(Entrepreneur)</option>
            <option value="clinician">임상/보건(Clinician)</option>
            <option value="policy">정책/공익(Policy/Nonprofit)</option>
          </select>
        </div>
        <div class="field">
          <label>내보내기</label>
          <div class="actions">
            <button class="btn secondary" onclick="downloadCSV()">CSV 내보내기</button>
            <button class="btn secondary" onclick="downloadTXT()">텍스트 보고서 저장</button>
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <h3 style="margin:0 0 8px">가중치(Weights)</h3>

      <div class="grid">
        <div class="field">
          <label>프롱1 — 장점/국가적 중요성</label>
          <div class="setting-row">
            <span>장점 분야 가중치</span>
            <input type="range" id="w_p1_merit" min="0.5" max="1.5" step="0.1" value="1" oninput="showVal(this)">
            <span class="value-badge" id="val_w_p1_merit">1.0</span>
          </div>
          <div class="setting-row">
            <span>파급 범위 가중치</span>
            <input type="range" id="w_p1_scope" min="0.5" max="1.5" step="0.1" value="1" oninput="showVal(this)">
            <span class="value-badge" id="val_w_p1_scope">1.0</span>
          </div>
          <div class="setting-row">
            <span>객관 증거 가중치</span>
            <input type="range" id="w_p1_evd" min="0.5" max="1.5" step="0.1" value="1" oninput="showVal(this)">
            <span class="value-badge" id="val_w_p1_evd">1.0</span>
          </div>
          <div class="setting-row">
            <span>긴급성 가중치</span>
            <input type="range" id="w_p1_urgency" min="0.5" max="1.5" step="0.1" value="1" oninput="showVal(this)">
            <span class="value-badge" id="val_w_p1_urgency">1.0</span>
          </div>
        </div>

        <div class="field">
          <label>프롱2 — Well‑positioned</label>
          <div class="setting-row"><span>논문</span><input type="range" id="w_pubs" min="0.5" max="1.5" step="0.1" value="1" oninput="showVal(this)"><span class="value-badge" id="val_w_pubs">1.0</span></div>
          <div class="setting-row"><span>인용</span><input type="range" id="w_cites" min="0.5" max="1.5" step="0.1" value="1" oninput="showVal(this)"><span class="value-badge" id="val_w_cites">1.0</span></div>
          <div class="setting-row"><span>h‑index</span><input type="range" id="w_hidx" min="0.5" max="1.5" step="0.1" value="1" oninput="showVal(this)"><span class="value-badge" id="val_w_hidx">1.0</span></div>
          <div class="setting-row"><span>특허</span><input type="range" id="w_pat" min="0.5" max="1.5" step="0.1" value="1" oninput="showVal(this)"><span class="value-badge" id="val_w_pat">1.0</span></div>
          <div class="setting-row"><span>피어리뷰</span><input type="range" id="w_reviews" min="0.5" max="1.5" step="0.1" value="1" oninput="showVal(this)"><span class="value-badge" id="val_w_reviews">1.0</span></div>
          <div class="setting-row"><span>발표</span><input type="range" id="w_talks" min="0.5" max="1.5" step="0.1" value="1" oninput="showVal(this)"><span class="value-badge" id="val_w_talks">1.0</span></div>
          <div class="setting-row"><span>수상</span><input type="range" id="w_awards" min="0.5" max="1.5" step="0.1" value="1" oninput="showVal(this)"><span class="value-badge" id="val_w_awards">1.0</span></div>
          <div class="setting-row"><span>미디어</span><input type="range" id="w_media" min="0.5" max="1.5" step="0.1" value="1" oninput="showVal(this)"><span class="value-badge" id="val_w_media">1.0</span></div>
          <div class="setting-row"><span>연구비</span><input type="range" id="w_fund" min="0.5" max="1.5" step="0.1" value="1" oninput="showVal(this)"><span class="value-badge" id="val_w_fund">1.0</span></div>
          <div class="setting-row"><span>지지</span><input type="range" id="w_support" min="0.5" max="1.5" step="0.1" value="1" oninput="showVal(this)"><span class="value-badge" id="val_w_support">1.0</span></div>
          <div class="setting-row"><span>실행계획</span><input type="range" id="w_plan" min="0.5" max="1.5" step="0.1" value="1" oninput="showVal(this)"><span class="value-badge" id="val_w_plan">1.0</span></div>
        </div>

        <div class="field">
          <label>프롱3 — 면제의 국익성</label>
          <div class="setting-row"><span>비실용 사유</span><input type="range" id="w_p3_impractical" min="0.5" max="1.5" step="0.1" value="1" oninput="showVal(this)"><span class="value-badge" id="val_w_p3_impractical">1.0</span></div>
          <div class="setting-row"><span>일자리</span><input type="range" id="w_p3_jobs" min="0.5" max="1.5" step="0.1" value="1" oninput="showVal(this)"><span class="value-badge" id="val_w_p3_jobs">1.0</span></div>
          <div class="setting-row"><span>정부 지지</span><input type="range" id="w_p3_gov" min="0.5" max="1.5" step="0.1" value="1" oninput="showVal(this)"><span class="value-badge" id="val_w_p3_gov">1.0</span></div>
          <div class="setting-row"><span>긴급성</span><input type="range" id="w_p3_urgency" min="0.5" max="1.5" step="0.1" value="1" oninput="showVal(this)"><span class="value-badge" id="val_w_p3_urgency">1.0</span></div>
        </div>
      </div>
    </div>

    <!-- Progress -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong id="stepTitle">시작하기</strong><div class="sub" id="stepSub">총 5단계 · 예상 10–15분</div></div>
        <div class="badge" id="progressText">진행률 0%</div>
      </div>
      <div class="progress"><div id="progressBar"></div></div>
    </div>

    <!-- Steps (same as before, omitted comments for brevity) -->
    <div class="card step active" data-step="0">
      <h2>환영합니다</h2>
      <p class="sub">이 앱은 Dhanasar 3프롱을 기준으로 EB‑2 NIW 자격을 예비 평가합니다. 가능한 범위에서 솔직하고 구체적으로 작성하세요.</p>
      <div class="grid">
        <div class="field"><label>전문분야/직함</label><input id="title" type="text" placeholder="예: 전지 소재 공학 연구원 / 데이터 사이언티스트"></div>
        <div class="field"><label>현재 근무지/국가</label><input id="location" type="text" placeholder="예: Seoul, Korea / Boston, MA"></div>
        <div class="field"><label>연락 이메일(선택)</label><input id="email" type="text" placeholder="예: name@example.com"></div>
      </div>
      <div class="nav"><div class="left"></div><div class="right"><button class="btn" onclick="next()">시작하기</button></div></div>
    </div>

    <div class="card step" data-step="1">
      <h2>1) EB‑2 기본 자격</h2>
      <p class="sub">A. 고급학위 또는 B. 예외적 능력 3개 이상</p>
      <div class="grid">
        <div class="field">
          <label>최종 학위</label>
          <select id="degree">
            <option value="phd_stem">박사(PhD) ‑ STEM</option>
            <option value="phd">박사(PhD) ‑ 비STEM</option>
            <option value="ms_stem">석사 ‑ STEM</option>
            <option value="ms">석사 ‑ 비STEM</option>
            <option value="bs5">학사 + 5년 점진적 경력</option>
            <option value="bs">학사 (5년 미만)</option>
            <option value="other">기타</option>
          </select>
        </div>
        <div class="field">
          <label>예외적 능력 기준 충족 개수(0~6)</label>
          <input id="ea_count" type="number" min="0" max="6" step="1" placeholder="예: 3">
        </div>
      </div>
      <div class="field"><label>전문직 해당 설명(선택)</label><textarea id="prodesc" placeholder="해당 분야가 최소 학사를 요구하는 전문직인지 간단 설명"></textarea></div>
      <div class="nav"><div class="left"><button class="btn ghost" onclick="prev()">이전</button></div><div class="right"><button class="btn" onclick="next()">다음</button></div></div>
    </div>

    <div class="card step" data-step="2">
      <h2>2) 프롱1 — 상당한 장점 & 국가적 중요성</h2>
      <div class="field"><label>제안된 노력(프로젝트/목표/대상)</label><textarea id="endeavor" placeholder="직함이 아닌, 목표·대상·활동을 구체적으로"></textarea></div>
      <div class="grid">
        <div class="field">
          <label>상당한 장점 분야(중복 선택: Ctrl/⌘)</label>
          <select id="merit" multiple size="6">
            <option>경제/산업 경쟁력</option><option>보건/의료</option><option>교육/인력개발</option><option>국가안보/핵심기술</option><option>환경/에너지</option><option>기타 공익</option>
          </select>
          <div class="muted">여러 항목을 선택하려면 Ctrl(또는 ⌘)키를 누른 채 클릭하세요.</div>
        </div>
        <div class="field">
          <label>파급 범위(Impact Scope)</label>
          <select id="scope"><option value="global">국제</option><option value="national" selected>국가</option><option value="regional">광역/州</option><option value="local">지역</option></select>
        </div>
      </div>
      <div class="grid">
        <div class="field"><label>객관 증거 개수(정부·산업/학술 리포트·언론·전문가 의견)</label><input id="p1_evd" type="number" min="0" step="1" placeholder="예: 5"></div>
        <div class="field"><label>긴급성/정책 적시성</label><select id="urgency1"><option value="high">높음</option><option value="mid" selected>보통</option><option value="low">낮음</option></select></div>
      </div>
      <div class="nav"><div class="left"><button class="btn ghost" onclick="prev()">이전</button></div><div class="right"><button class="btn" onclick="next()">다음</button></div></div>
    </div>

    <div class="card step" data-step="3">
      <h2>3) 프롱2 — 잘 갖춰진 위치(Well‑positioned)</h2>
      <div class="grid">
        <div class="field"><label>논문 수</label><input id="pubs" type="number" min="0" step="1" placeholder="예: 12"></div>
        <div class="field"><label>총 인용 수</label><input id="cites" type="number" min="0" step="1" placeholder="예: 350"></div>
        <div class="field"><label>h‑index</label><input id="hidx" type="number" min="0" step="1" placeholder="예: 12"></div>
        <div class="field"><label>특허(등록)</label><input id="pat" type="number" min="0" step="1" placeholder="예: 2"></div>
      </div>
      <div class="grid">
        <div class="field"><label>피어리뷰 초청</label><input id="reviews" type="number" min="0" step="1" placeholder="예: 10"></div>
        <div class="field"><label>초청 발표</label><input id="talks" type="number" min="0" step="1" placeholder="예: 6"></div>
        <div class="field"><label>수상</label><input id="awards" type="number" min="0" step="1" placeholder="예: 2"></div>
        <div class="field"><label>미디어/언론 보도</label><input id="media" type="number" min="0" step="1" placeholder="예: 3"></div>
      </div>
      <div class="grid">
        <div class="field"><label>외부/정부 연구비(USD)</label><input id="fund" type="number" min="0" step="1000" placeholder="예: 250000"></div>
        <div class="field"><label>관심/지지(기관·투자자·사용자) 건수</label><input id="support" type="number" min="0" step="1" placeholder="예: 3"></div>
        <div class="field"><label>실행 계획/모델 보유</label><select id="plan"><option value="yes">예</option><option value="no" selected>아니오</option></select></div>
      </div>
      <div class="nav"><div class="left"><button class="btn ghost" onclick="prev()">이전</button></div><div class="right"><button class="btn" onclick="next()">다음</button></div></div>
    </div>

    <div class="card step" data-step="4">
      <h2>4) 프롱3 — 노동인증 면제가 국익에 부합</h2>
      <div class="field">
        <label>노동인증 비실용 사유(중복 선택: Ctrl/⌘)</label>
        <select id="impractical" multiple size="6">
          <option>창업/자영·PI 중심 연구</option><option>고유/희소 기술·대체곤란성</option><option>다기관 협업·직무 유동적</option><option>정책/공익 프로젝트</option><option>보안·클리어런스 등 특수성</option><option>기타</option>
        </select>
      </div>
      <div class="grid">
        <div class="field"><label>예상 일자리 창출(명)</label><input id="jobs" type="number" min="0" step="1" placeholder="예: 5"></div>
        <div class="field"><label>정부/준정부 지지서(건수)</label><input id="gov" type="number" min="0" step="1" placeholder="예: 1"></div>
        <div class="field"><label>긴급성(시간 민감)</label><select id="urgency3"><option value="high">높음</option><option value="mid" selected>보통</option><option value="low">낮음</option></select></div>
      </div>
      <div class="field"><label>국익 설명(선택)</label><textarea id="public" placeholder="경제효과/공익/경쟁력/안보 등"></textarea></div>
      <div class="nav"><div class="left"><button class="btn ghost" onclick="prev()">이전</button></div><div class="right"><button class="btn" onclick="next()">다음</button></div></div>
    </div>

    <div class="card step" data-step="5">
      <h2>5) 검토 & 리포트 생성</h2>
      <p class="sub">입력 내용을 간략히 확인한 뒤, <strong>예비 평가 생성</strong>을 누르세요.</p>
      <div class="result" id="previewBox"></div>
      <div class="nav">
        <div class="left"><button class="btn ghost" onclick="prev()">이전</button></div>
        <div class="right">
          <button class="btn" onclick="evaluate()">예비 평가 생성</button>
          <button class="btn secondary" onclick="window.print()">PDF/인쇄</button>
        </div>
      </div>

      <div id="out" class="result" style="display:none;margin-top:12px"></div>

      <div class="card" id="emailSim" style="display:none;margin-top:12px">
        <h2>이메일 발송 안내(시뮬레이션)</h2>
        <p>축하드립니다! 귀하의 EB‑2 NIW 자격 평가서가 <strong>전홍민 변호사 사무실 (askus@junlawfirm.com)</strong>로 성공적으로 발송되었습니다. 저희 팀이 검토 후 연락드리겠습니다.</p>
        <p class="muted">참고: 이 웹 앱은 실제 이메일을 발송하지 않습니다. 아래 버튼을 눌러 <strong>평가 요약을 복사</strong>하여 <em>askus@junlawfirm.com</em>으로 보내주시면 더 신속히 검토됩니다.</p>
        <div class="actions">
          <button class="btn" onclick="copyReport()">평가 요약 복사</button>
          <a id="mailtoLink" class="btn ghost" href="#" target="_blank" rel="noopener">메일 작성 열기</a>
        </div>
      </div>
    </div>

    <footer>© Law Office of Hong‑min Jun — EB‑2 NIW Assessment App · 
      <strong>최종 서류화는 저희 전홍민 변호사 사무실과 상의하시기를 권유합니다.</strong>
    </footer>
  </div>

<script>
// ----- Wizard state -----
const TOTAL_STEPS = 5; // 0..5
let step = 0;
function updateProgress(){
  const pct = Math.round((step)/TOTAL_STEPS*100);
  document.getElementById('progressBar').style.width = pct + '%';
  document.getElementById('progressText').innerText = '진행률 ' + pct + '%';
  const titles=['시작하기','EB‑2 기본 자격','프롱1 — 장점·국가적 중요성','프롱2 — Well‑positioned','프롱3 — 국익성','검토 & 리포트'];
  document.getElementById('stepTitle').innerText = titles[step]||'진행';
  document.getElementById('stepSub').innerText = '총 5단계 · 예상 10–15분';
}
function showStep(n){
  step = Math.max(0, Math.min(TOTAL_STEPS, n));
  document.querySelectorAll('.step').forEach(el=>el.classList.remove('active'));
  const el = document.querySelector(`.step[data-step="${step}"]`);
  if(el) el.classList.add('active');
  updateProgress();
  if(step===5){ buildPreview(); }
}
function next(){ showStep(step+1); }
function prev(){ showStep(step-1); }

// ----- Helpers -----
function val(id){ const el=document.getElementById(id); return el?el.value:''; }
function num(id){ const v=val(id); const x=parseFloat(v); return isNaN(x)?0:x; }
function msel(id){ const el=document.getElementById(id); return el?Array.from(el.selectedOptions).map(o=>o.value):[]; }

// ----- Settings (weights) -----
const W_KEYS = ['p1_merit','p1_scope','p1_evd','p1_urgency','pubs','cites','hidx','pat','reviews','talks','awards','media','fund','support','plan','p3_impractical','p3_jobs','p3_gov','p3_urgency'];
const weights = Object.fromEntries(W_KEYS.map(k=>[k,1]));
function showVal(r){ const id='val_'+r.id; const el=document.getElementById(id); if(el) el.innerText = parseFloat(r.value).toFixed(1); weights[r.id.replace('w_','')] = parseFloat(r.value); saveWeights(); }
function toggleSettings(){ document.getElementById('settingsPanel').classList.toggle('active'); }
function applyProfile(){
  const p = val('profile');
  // reset
  W_KEYS.forEach(k=>weights[k]=1);
  if(p==='academic'){
    weights.cites=1.2; weights.pubs=1.1; weights.hidx=1.1; weights.pat=0.9; weights.fund=1.1; weights.support=1.0;
    weights.p1_evd=1.1; weights.p1_scope=1.0; weights.p1_merit=1.0;
  }else if(p==='entre'){
    weights.pat=1.2; weights.support=1.2; weights.plan=1.1; weights.p3_jobs=1.2; weights.fund=1.0; weights.cites=0.9;
  }else if(p==='clinician'){
    weights.p1_scope=1.1; weights.p1_evd=1.1; weights.awards=1.1;
  }else if(p==='policy'){
    weights.p1_merit=1.2; weights.p1_evd=1.2; weights.p3_gov=1.1;
  }
  // push to sliders
  W_KEYS.forEach(k=>{
    const s=document.getElementById('w_'+k), v=document.getElementById('val_w_'+k);
    if(s){ s.value=weights[k]; }
    if(v){ v.innerText=weights[k].toFixed(1); }
  });
  saveWeights();
}
function saveWeights(){
  try{ localStorage.setItem('niw_weights', JSON.stringify({weights,profile:val('profile')})); }catch(e){}
}
function loadWeights(){
  try{
    const data = JSON.parse(localStorage.getItem('niw_weights')||'{}');
    if(data.weights){
      Object.assign(weights, data.weights);
      W_KEYS.forEach(k=>{
        const s=document.getElementById('w_'+k), v=document.getElementById('val_w_'+k);
        if(s){ s.value=weights[k]; }
        if(v){ v.innerText=weights[k].toFixed(1); }
      });
    }
    if(data.profile){ document.getElementById('profile').value=data.profile; }
  }catch(e){}
}

// ----- Persist (form) -----
const KEY='niw_app_draft_v2';
function saveDraft(){
  const data = collectAll();
  localStorage.setItem(KEY, JSON.stringify(data));
  alert('진행 상황을 저장했습니다.');
}
function loadDraft(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw){ alert('저장된 내역이 없습니다.'); return; }
    const d = JSON.parse(raw);
    fillAll(d);
    alert('저장 내역을 불러왔습니다.');
  }catch(e){ alert('불러오기에 실패했습니다.'); }
}
function resetAll(){
  if(!confirm('모든 입력을 초기화하시겠습니까?')) return;
  localStorage.removeItem(KEY);
  document.querySelectorAll('input,textarea').forEach(el=>el.value='');
  document.querySelectorAll('select').forEach(el=>{
    if(el.multiple){ Array.from(el.options).forEach(o=>o.selected=false); }
    else{ el.selectedIndex=0; }
  });
  showStep(0);
  document.getElementById('out').style.display='none';
  document.getElementById('emailSim').style.display='none';
}

// ----- Collect/Fill -----
function collectAll(){
  return {
    title:val('title'), location:val('location'), email:val('email'),
    degree:val('degree'), ea_count:num('ea_count'), prodesc:val('prodesc'),
    endeavor:val('endeavor'), merit:msel('merit'), scope:val('scope'),
    p1_evd:num('p1_evd'), urgency1:val('urgency1'),
    pubs:num('pubs'), cites:num('cites'), hidx:num('hidx'), pat:num('pat'),
    reviews:num('reviews'), talks:num('talks'), awards:num('awards'), media:num('media'),
    fund:num('fund'), support:num('support'), plan:val('plan'),
    impractical:msel('impractical'), jobs:num('jobs'), gov:num('gov'), urgency3:val('urgency3'),
    public:val('public')
  };
}
function fillAll(d){
  const S = new Set(Object.keys(d||{}));
  function setVal(id,v){ const el=document.getElementById(id); if(!el) return; el.value=v; }
  ['title','location','email','degree','ea_count','prodesc','endeavor','scope','p1_evd','urgency1','pubs','cites','hidx','pat','reviews','talks','awards','media','fund','support','plan','jobs','gov','urgency3','public']
    .forEach(id=>{ if(S.has(id)) setVal(id,d[id]); });
  if(S.has('merit')){
    const el=document.getElementById('merit');
    Array.from(el.options).forEach(o=>o.selected = (d.merit||[]).includes(o.value));
  }
  if(S.has('impractical')){
    const el=document.getElementById('impractical');
    Array.from(el.options).forEach(o=>o.selected = (d.impractical||[]).includes(o.value));
  }
}

// ----- Preview -----
function buildPreview(){
  const d = collectAll();
  const list = [
    ['전문분야/직함', d.title],
    ['근무지', d.location],
    ['학위', d.degree],
    ['예외적 능력 기준(개수)', d.ea_count],
    ['제안된 노력', (d.endeavor||'').slice(0,180)+(d.endeavor&&d.endeavor.length>180?'…':'')],
    ['상당한 장점 분야', (d.merit||[]).join(', ')||''],
    ['파급 범위', d.scope],
    ['프롱1 객관증거(개)', d.p1_evd],
    ['논문/인용/h‑index', `${d.pubs}/${d.cites}/${d.hidx}`],
    ['특허/리뷰/발표/수상/미디어', `${d.pat}/${d.reviews}/${d.talks}/${d.awards}/${d.media}`],
    ['연구비(USD)/지지(건)/계획', `$${d.fund.toLocaleString()}/${d.support}/${d.plan}`],
    ['프롱3 사유(선택수)/정부지지/일자리/긴급성', `${(d.impractical||[]).length}/${d.gov}/${d.jobs}/${d.urgency3}`]
  ];
  const html = list.map(([k,v])=>`<span class="pill"><strong>${k}</strong>: ${v??''}</span>`).join('');
  const box = document.getElementById('previewBox');
  box.innerHTML = html || '<span class="muted">입력 정보가 표시됩니다.</span>';
}

// ----- Evaluation (heuristic with weights) -----
function evaluate(){
  const d = collectAll();
  // Baseline
  let eb2_ok = false;
  if(['phd_stem','phd','ms_stem','ms','bs5'].includes(d.degree)) eb2_ok = true;
  if(d.ea_count >= 3) eb2_ok = true;
  const eb2_note = eb2_ok? 'EB‑2 기본요건 충족 가능': 'EB‑2 기본요건 보완 필요(고급학위 또는 예외적 능력 3개 이상)';

  // Prong1
  const meritCnt = (d.merit||[]).length;
  let p1 = 0;
  p1 += Math.min(meritCnt,5) * 6 * weights.p1_merit; // up to 30 * w
  p1 += (d.scope==='global'?35:(d.scope==='national'?25:(d.scope==='regional'?15:5))) * weights.p1_scope; // up to 35 * w
  p1 += (Math.min(d.p1_evd,20)/20*25) * weights.p1_evd; // up to 25 * w
  p1 += ((d.urgency1==='high'?10:(d.urgency1==='mid'?5:0))) * weights.p1_urgency; // up to 10 * w
  p1 = Math.min(p1,100);

  // Prong2
  let p2 = 0;
  p2 += (d.degree==='phd_stem'?15:d.degree==='phd'?12:d.degree==='ms_stem'?10:d.degree==='ms'?8:d.degree==='bs5'?6:2); // degree base
  p2 += Math.min(d.pubs,20)/20*10 * weights.pubs;
  p2 += Math.min(d.cites,1000)/1000*15 * weights.cites;
  p2 += Math.min(d.hidx,25)/25*8 * weights.hidx;
  p2 += Math.min(d.pat,10)/10*8 * weights.pat;
  p2 += Math.min(d.reviews,30)/30*8 * weights.reviews;
  p2 += Math.min(d.talks,20)/20*4 * weights.talks;
  p2 += Math.min(d.awards,10)/10*4 * weights.awards;
  p2 += Math.min(d.media,10)/10*3 * weights.media;
  p2 += Math.min(d.fund/1000000,1)*10 * weights.fund;
  p2 += Math.min(d.support,10)/10*5 * weights.support;
  p2 += (d.plan==='yes'?10:0) * weights.plan;
  p2 = Math.min(p2,100);

  // Prong3
  const impracticalCnt = (d.impractical||[]).length;
  let p3 = 0;
  p3 += Math.min(impracticalCnt,5)*10 * weights.p3_impractical;
  p3 += Math.min(d.jobs,50)/50*15 * weights.p3_jobs;
  p3 += Math.min(d.gov,5)/5*20 * weights.p3_gov;
  p3 += (d.urgency3==='high'?15:(d.urgency3==='mid'?8:0)) * weights.p3_urgency;
  p3 = Math.min(p3,100);

  function band(x){ return x>=70?'Strong':(x>=50?'Moderate':'Weak'); }
  const b1=band(p1), b2=band(p2), b3=band(p3);
  const summary = `${b1}/${b2}/${b3} (프롱1/2/3). ${eb2_note}.`;

  // Tailored advice
  const adv=[];
  if(!eb2_ok) adv.push('고급학위 또는 예외적 능력 3개 이상 충족 증거를 먼저 정리하세요.');
  if(p1<70){
    if(d.scope==='local'||d.scope==='regional') adv.push('국가적 중요성 입증 강화: 국가/산업 차원의 파급 효과 자료(정부·산업 리포트, 표준화·정책 반영) 확보.');
    if(d.p1_evd<6) adv.push('프롱1 객관 증거(정부·학술·산업 리포트, 언론·데이터) 인용을 최소 6개 이상으로 확대.');
  }
  if(p2<70){
    if(d.cites<200) adv.push('독립 인용(공동저자 제외)을 중심으로 핵심 논문 영향력 정리.');
    if(d.pat<1 && d.pubs<6) adv.push('핵심 산출물 보강: 특허 등록 또는 고임팩트 출판 확보.');
    if(d.plan!=='yes') adv.push('구체 실행 계획/타임라인/마일스톤 문서화.');
    if(d.support<2) adv.push('기관/투자자/사용자의 관심·지지(LOI/지원서)를 최소 2건 이상 확보.');
  }
  if(p3<70){
    if(impracticalCnt<2) adv.push('노동인증 비실용 사유를 구체화(창업·PI주도·고유기술 등)하고 근거 문서화.');
    if(d.gov<1) adv.push('정부/준정부기관 또는 공공성 있는 단체의 지지서 확보 검토.');
    if(d.jobs<3) adv.push('일자리 창출·경제효과 예측(보수적 추정+근거 모델) 제시.');
  }

  const out=document.getElementById('out');
  out.style.display='block';
  out.innerHTML = `
    <h3 style="margin:0 0 6px">예비 평가 결과</h3>
    <div class="kv">
      <span class="pill"><strong>프롱1</strong>: ${b1} (${Math.round(p1)}/100)</span>
      <span class="pill"><strong>프롱2</strong>: ${b2} (${Math.round(p2)}/100)</span>
      <span class="pill"><strong>프롱3</strong>: ${b3} (${Math.round(p3)}/100)</span>
    </div>
    <div class="hr"></div>
    <p><strong>요약:</strong> ${summary}</p>
    <p class="muted">※ 점수/등급은 내부 휴리스틱에 따른 <em>참고치</em>입니다. 서술·근거의 질이 수치보다 중요합니다.</p>
    <h4 style="margin:10px 0 6px">권장 증거 체크리스트</h4>
    <div class="kv">
      <span class="pill">국가/산업 차원 객관 자료 인용</span>
      <span class="pill">실행계획·마일스톤 문서화</span>
      <span class="pill">독립 인용·핵심 산출물 강조</span>
      <span class="pill">지지/관심(LOI·지원서) 확보</span>
      <span class="pill">정부/준정부기관 지지서 모색</span>
      <span class="pill">경제효과·일자리 모델 제시</span>
    </div>
    ${adv.length?('<div class="hr"></div><h4 style="margin:10px 0 6px">맞춤 보완 제안</h4><ul style="margin:6px 0 0 18px">'+adv.map(a=>'<li>'+a+'</li>').join('')+'</ul>'):''}
    <div class="hr"></div>
    <p class="muted"><strong>주의:</strong> 본 평가는 법률 자문이 아니며, <strong>최종 서류화는 저희 전홍민 변호사 사무실과 상의하시기를 권유합니다.</strong></p>
  `;

  // Email simulation & copy
  document.getElementById('emailSim').style.display='block';
  const reportText = buildTextReport(summary, b1,p1, b2,p2, b3,p3, adv);
  window.__reportText = reportText;
  const mail = 'askus@junlawfirm.com';
  const subject = encodeURIComponent('[NIW 예비 평가] ' + (d.title||'지원자') );
  const body = encodeURIComponent(reportText + '\n\n— EB‑2 NIW Assessment App');
  document.getElementById('mailtoLink').href = `mailto:${mail}?subject=${subject}&body=${body}`;
}
function buildTextReport(summary, b1,p1,b2,p2,b3,p3,adv){
  const d = collectAll();
  return `EB‑2 NIW 예비 평가 보고서
--------------------------------
[신청자 요약]
직함/전문분야: ${d.title||''}
근무지: ${d.location||''}
이메일: ${d.email||''}

[EB‑2 기본 자격]
최종 학위: ${d.degree}
예외적 능력 기준(개수): ${d.ea_count}
코멘트: ${( ['phd_stem','phd','ms_stem','ms','bs5'].includes(d.degree) || d.ea_count>=3 ) ? 'EB‑2 기본요건 충족 가능' : '보완 필요' }

[Dhanasar 프롱 평가]
프롱1(장점·국가적 중요성): ${b1} (${Math.round(p1)}/100)
- 제안된 노력: ${d.endeavor||''}
- 장점 분야: ${(d.merit||[]).join(', ')}
- 파급 범위: ${d.scope}
- 객관 증거(개): ${d.p1_evd}

프롱2(Well‑positioned): ${b2} (${Math.round(p2)}/100)
- 논문/인용/h-index: ${d.pubs}/${d.cites}/${d.hidx}
- 특허/리뷰/발표/수상/미디어: ${d.pat}/${d.reviews}/${d.talks}/${d.awards}/${d.media}
- 연구비/지지/계획: $${d.fund.toLocaleString()}/${d.support}/${d.plan}

프롱3(국익성·면제 타당): ${b3} (${Math.round(p3)}/100)
- 비실용 사유(선택수): ${(d.impractical||[]).length}
- 정부/준정부 지지(건): ${d.gov}
- 일자리 창출(명): ${d.jobs}
- 긴급성: ${d.urgency3}
- 국익 설명: ${d.public||''}

[요약]
${summary}

[맞춤 보완 제안]
${adv.length?('- '+adv.join('\n- ')):'(별도 권고 없음)'}

[주의] 본 평가는 참고용이며 법률 자문이 아닙니다. 최종 서류화는 저희 전홍민 변호사 사무실과 상의하시기를 권유합니다.
`;
}
function copyReport(){
  const t = window.__reportText || '먼저 예비 평가를 생성하세요.';
  navigator.clipboard.writeText(t).then(()=>{
    alert('평가 요약을 클립보드에 복사했습니다.');
  },()=>{ alert('복사에 실패했습니다. 먼저 평가를 생성해 주세요.'); });
}

// ----- Exports -----
function downloadCSV(){
  const d = collectAll();
  const rows = [
    ['field','value'],
    ['title', d.title], ['location', d.location], ['email', d.email],
    ['degree', d.degree], ['ea_count', d.ea_count], ['prodesc', d.prodesc],
    ['endeavor', d.endeavor], ['merit', (d.merit||[]).join(';')], ['scope', d.scope],
    ['p1_evd', d.p1_evd], ['urgency1', d.urgency1],
    ['pubs', d.pubs], ['cites', d.cites], ['hidx', d.hidx], ['pat', d.pat],
    ['reviews', d.reviews], ['talks', d.talks], ['awards', d.awards], ['media', d.media],
    ['fund', d.fund], ['support', d.support], ['plan', d.plan],
    ['impractical', (d.impractical||[]).join(';')], ['jobs', d.jobs], ['gov', d.gov], ['urgency3', d.urgency3],
    ['public', d.public]
  ];
  const csv = rows.map(r=>r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'niw_assessment.csv'; a.click(); URL.revokeObjectURL(url);
}
function downloadTXT(){
  const t = window.__reportText || buildTextReport('', '',0,'',0,'',0,[]);
  const blob = new Blob([t],{type:'text/plain;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'niw_assessment_report.txt'; a.click(); URL.revokeObjectURL(url);
}

// Init
function updateProgressInit(){ updateProgress(); }
updateProgressInit();
loadWeights();
</script>
</body>
</html>
